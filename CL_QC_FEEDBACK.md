# CL_QC_FEEDBACK.md

## 🔄 프로젝트 전반 반복 발생 문제 기록

### 목적
- 동일한 문제가 반복 발생하는 것을 방지
- 문제 해결 패턴 학습 및 개선
- 개발 효율성 향상

### 반복 문제 카테고리

#### 1. Express 라우터 미들웨어 관련
**문제**: requireAuth, requireOperator 등 정의되지 않은 미들웨어 사용
**해결책**: requireRole('operator', 'admin', 'super_admin') 패턴만 사용
**발생 빈도**: 높음
**예방 방법**: 모든 라우터 파일에서 requireRole 패턴 강제 적용

#### 2. EJS 템플릿 JavaScript 충돌
**문제**: 템플릿 리터럴(`${}`) 사용으로 EJS 파서 충돌
**해결책**: 문자열 연결('text' + variable + 'text') 방식 사용
**발생 빈도**: 보통
**예방 방법**: EJS 파일 내 JavaScript는 문자열 연결만 사용

#### 3. UTF-8 인코딩 문제
**문제**: 한글이 `?�`로 표시되는 인코딩 이슈
**해결책**: BOM 없는 UTF-8로 파일 재저장
**발생 빈도**: 보통
**예방 방법**: 한글 포함 파일은 항상 UTF-8 인코딩 확인

#### 4. PostgreSQL 연결 관련
**문제**: 데이터베이스 연결 끊김 또는 쿼리 실패
**해결책**: 연결 풀 관리 및 에러 핸들링 강화
**발생 빈도**: 낮음
**예방 방법**: DB 연결 상태 모니터링 및 자동 재연결

#### 5. 대시보드 시스템 메트릭 표시 오류 ✅ **완전 해결 완료 (2025-09-28 20:55)**
**문제**:
- CPU 사용률 [object Object]% 표시 → ✅ **19%** 정상 표시
- 메모리 사용률 [object Object]% 표시 → ✅ **45%** 정상 표시
- 디스크 사용률 [object Object]% 표시 → ✅ **25%** 정상 표시
- 중복된 서버 목록 표시
- 데이터베이스 서버가 별도 표시되어 대시보드 통합 요구

**✅ 해결 완료 (2025-09-28 20:55)** - **6회 반복 문제 최종 완전 해결**:
- **1차 수정**: `src/server_v2.js` API 엔드포인트에 safeNumber() 함수 추가
- **2차 수정**: `src/views/dashboard.ejs` 템플릿 안전 처리 로직 추가
- **3차 수정**: `views/dashboard.ejs` 템플릿 안전 처리 로직 추가
- **4차 수정**: 서버 렌더링 함수에서 사전 포맷팅 추가
- **검증 완료**: 실제 웹 UI에서 CPU(19%), 메모리(45%), 디스크(25%) 정상 표시

**발생 빈도**: **해결됨 (근본 원인 완전 제거)**
**우선순위**: **완료 (Resolved)**
**근본 예방 방법**:
- ❌ 절대 금지: 시스템 메트릭 객체를 직접 템플릿에 전달
- ✅ 필수 사용: safeNumber() 변환 함수로 모든 숫자 데이터 전처리
- ✅ 검증 절차: 실제 웹 UI에서 표시 결과 직접 확인
- 🔍 코드 리뷰: 모든 EJS 템플릿에서 객체 안전 처리 확인

#### 6. 서버 상태 표시 "불명" 문제 🚨 **반복 문제 5회 이상**
**문제**:
- 헬스체크는 정상 작동하고 로그에서 healthy/offline 상태 정확히 감지
- 웹 UI에서는 지속적으로 "불명(unknown)" 상태로 표시
- 데이터베이스 업데이트가 웹 UI에 반영되지 않음
- 동일한 문제가 반복적으로 발생 (5회 이상)

**현재 상황 (2025-01-08 18:42)**:
- 서버 로그: golchin-admin (healthy), learning-assistant (healthy), golf-course (offline)
- 웹 UI 표시: 모든 서버가 "불명" 상태로 잘못 표시됨

**근본 원인**:
- 헬스체크 → 데이터베이스 업데이트 → 웹 UI 표시 연결 고리 중 어딘가 끊어짐
- 실시간 업데이트 메커니즘 작동 불량
- 캐싱 또는 세션 문제 가능성

**해결책**:
- 헬스체크 결과의 DB 저장 확인
- 웹 UI의 실시간 데이터 조회 로직 점검
- 브라우저 캐시/세션 무효화 확인

**발생 빈도**: **극도로 높음 (5회 이상 반복)**
**우선순위**: **최긴급 (Critical)**

**✅ 해결 완료 (2025-09-28 04:15)** - **최종 완전 해결**:
- **1차 해결**: getServerStatus() 함수 하드코딩 'unknown' → 실제 DB 조회로 변경
- **2차 해결**: 데이터베이스 스키마 불일치 (`checked_at` → `created_at`) 수정
- **3차 해결**: API-EJS 필드명 불일치 (`server.status` → `server.current_status`) 수정
- **수정 파일**: `src/views/dashboard.ejs`, `src/views/server-detail.ejs`, `views/dashboard.ejs`
- **상태 매핑**: `running/stopped` → `healthy/offline/unhealthy/unknown`
- **검증 완료**: 모든 서버 상태가 정확히 표시됨

**완전 예방 방법**:
- ❌ 절대 금지: 하드코딩된 상태 값, 스키마 추정, 필드명 불일치
- ✅ 필수 사용: 실제 DB 스키마 확인, API-EJS 필드명 일치 확인
- ✅ 검증 절차: 실제 웹 UI에서 표시 결과 직접 확인
- 🔍 코드 리뷰: API 응답과 EJS 템플릿 필드명 일관성 확인

### 해결 우선순위 체크리스트
1. **서버 로그 확인**: "라우터 등록 완료" 메시지 존재 여부
2. **EJS 컴파일 에러**: JavaScript 템플릿 리터럴 사용 여부
3. **undefined 변수**: 라우터에서 뷰로 데이터 전달 확인
4. **인코딩 문제**: UTF-8 재저장 후 서버 재시작

#### 7. 데이터베이스 스키마 컬럼명 불일치 문제 ⚠️ **신규 반복 방지 대상**
**문제**:
- SQL 쿼리에서 존재하지 않는 컬럼명 사용
- health_logs 테이블: 스키마는 `checked_at`, 쿼리는 `check_time` 사용
- "check_time" 이름의 칼럼은 없습니다 오류 발생

**근본 원인**:
- 스키마 정의와 쿼리 간 컬럼명 불일치
- 테이블 구조 확인 없이 추정으로 쿼리 작성

**✅ 해결 완료 (2025-09-28 04:00)** - **근본 해결**:
- **진단**: Node.js로 실제 데이터베이스 스키마 직접 확인
- **발견**: `health_logs` 테이블에는 `created_at` 컬럼만 존재, `checked_at` 존재하지 않음
- **수정**: `src/services/serverService_v2.js`에서 모든 `checked_at` → `created_at` 일괄 변경 (7개 라인)
- **검증**: 서버 재시작 후 헬스체크 정상 작동 확인, 컬럼 에러 완전 제거

**발생 빈도**: **해결됨 (근본 원인 제거)**
**우선순위**: **완료 (Resolved)**
**근본 예방 방법**:
- ❌ 절대 금지: 스키마 확인 없이 추정으로 컬럼명 사용
- ✅ 필수 사용: **실제 데이터베이스 스키마 직접 확인** (information_schema.columns 쿼리)
- ✅ 검증 절차: 새로운 쿼리 작성 시 반드시 실제 DB 구조 확인
- 🔍 코드 리뷰: 모든 SQL 쿼리에서 실제 컬럼 존재 여부 확인
- ⚡ 긴급 조치: PostgreSQL 에러 힌트 메시지를 즉시 반영

### 금지 패턴
- ❌ requireAuth, requireOperator, checkRole 사용
- ❌ EJS 내부에서 템플릿 리터럴 사용
- ❌ Mock 데이터나 하드코딩
- ❌ Layout 패턴 사용 (Include 패턴만 허용)
- ❌ 스키마 확인 없이 추정으로 컬럼명 사용 (신규 추가)

### 권장 패턴
- ✅ requireRole('role1', 'role2') 사용
- ✅ 문자열 연결 방식 사용
- ✅ PostgreSQL 기반 실제 데이터
- ✅ Include 패턴으로 템플릿 구성

#### 8. 서버 중단 문제 반복 발생 🚨 **신규 반복 문제**
**문제**:
- OMEN Gateway v2.0 서버가 주기적으로 중단됨
- 사용자가 연결 시도 시 "연결 안됨" 문제 반복 발생
- 매번 수동으로 서버 재시작 필요

**근본 원인 분석 (2025-01-08 15:25)**:
1. **다중 Node.js 프로세스**: 11개의 node.exe 프로세스가 동시 실행 중
   - 메모리 사용량: 53MB~239MB (총 1.3GB 이상)
   - 포트 충돌 및 리소스 경합 가능성

2. **과도한 DB 연결**: 30초마다 헬스체크 시 과도한 DB 연결 생성
   - 로그에서 "클라이언트 획득됨 (PID: 31308, 39804, 54796)" 반복
   - PostgreSQL 연결 풀 고갈 가능성

3. **메모리 누수**: 장시간 실행 시 메모리 사용량 증가
   - 가비지 컬렉션 문제 가능성
   - 이벤트 리스너 누적 가능성

**해결책**:
- 중복 Node.js 프로세스 정리
- DB 연결 풀 최적화
- 메모리 누수 점검 및 수정
- 자동 재시작 메커니즘 구현
- PM2 또는 forever 같은 프로세스 매니저 도입

**발생 빈도**: **높음 (매 세션마다 재발)**
**우선순위**: **긴급 (Urgent)**
**예방 방법**:
- ✅ 서버 시작 전 기존 프로세스 정리
- ✅ DB 연결 풀 크기 제한 및 모니터링
- ✅ 메모리 사용량 모니터링 및 경고
- ✅ 자동 재시작 스크립트 구현

#### 9. 시스템 점검 및 QC 절차 개선 ✅ **신규 체계화**
**배경**:
- 사용자가 시스템 전반적인 점검 요청
- 데이터베이스 API/라우터 등록 상태 확인 필요
- 테이블명 불일치 문제 사전 예방 필요
- 세션 연속성 관리 개선 필요

**개선 사항 (2025-09-29 14:46)**:
1. **영어 번역 시스템**: 지침에 따른 번역 체계 구축
2. **체크포인트 기록**: 모든 요청사항을 root_checkpoint.md에 체계적 기록
3. **QC 기록 체계**: CL_QC_FEEDBACK.md에 문제 패턴 축적
4. **DB API/라우터 검증**: 등록 상태 자동 점검 프로세스
5. **테이블명 일관성**: 스키마와 쿼리 간 불일치 사전 검출
6. **세션 연속성**: 체크포인트 파일 기반 연속성 보장

**예방 효과**:
- ✅ 체계적인 문제 추적 및 해결
- ✅ 반복 문제 사전 방지
- ✅ 세션 간 연속성 보장
- ✅ 품질 관리 체계 구축

**발생 빈도**: **신규 구축**
**우선순위**: **중요 (Important)**

---
*최종 업데이트: 2025-09-29 14:46*
*다음 업데이트: 문제 발생 시 즉시*
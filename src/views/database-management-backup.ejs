<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬ - OMEN ê²Œì´íŠ¸ì›¨ì´</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f7fafc;
            line-height: 1.6;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { font-size: 24px; }
        .header a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            border-radius: 5px;
            margin-left: 10px;
        }
        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }
        .breadcrumb {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .breadcrumb a {
            color: #667eea;
            text-decoration: none;
        }
        .db-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        .tables-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 30px;
        }
        .section-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .section-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }
        .table-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px;
        }
        .table-card {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
        }
        .table-card-header {
            background: #667eea;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .table-name {
            font-weight: bold;
            font-size: 16px;
        }
        .record-count {
            background: rgba(255,255,255,0.2);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        .table-info {
            padding: 15px;
        }
        .table-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .table-actions {
            padding: 15px;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s;
        }
        .btn-view { background: #48bb78; color: white; }
        .btn-backup { background: #ed8936; color: white; }
        .btn-analyze { background: #667eea; color: white; }
        .btn:hover { opacity: 0.8; }
        .query-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 30px;
        }
        .query-input {
            width: 100%;
            min-height: 120px;
            padding: 20px;
            border: none;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            background: #2d3748;
            color: #e2e8f0;
        }
        .query-controls {
            padding: 20px;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .btn-execute {
            background: #48bb78;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        .query-results {
            max-height: 400px;
            overflow: auto;
            padding: 20px;
        }
        .results-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        .results-table th,
        .results-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        .results-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #48bb78;
        }
        .status-text {
            font-weight: 600;
            color: #333;
        }
        .backup-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 20px;
        }
        .backup-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        .backup-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .backup-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ–¥ï¸ OMEN ì„œë²„ ê²Œì´íŠ¸ì›¨ì´</h1>
        <div>
            <a href="/">ëŒ€ì‹œë³´ë“œ</a>
            <a href="/database">ë°ì´í„°ë² ì´ìŠ¤</a>
            <a href="/logout">ë¡œê·¸ì•„ì›ƒ</a>
        </div>
    </div>

    <div class="container">
        <div class="breadcrumb">
            <a href="/">ëŒ€ì‹œë³´ë“œ</a> > ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬
        </div>

        <div class="connection-status">
            <span class="status-indicator"></span>
            <span class="status-text">PostgreSQL 17.5 ì—°ê²°ë¨</span>
            <span style="color: #666; margin-left: auto;">ë°ì´í„°ë² ì´ìŠ¤: omen_gateway</span>
        </div>

        <div class="db-stats">
            <div class="stat-card">
                <div class="stat-value" id="total-tables">6</div>
                <div class="stat-label">ì´ í…Œì´ë¸” ìˆ˜</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-records">18</div>
                <div class="stat-label">ì´ ë ˆì½”ë“œ ìˆ˜</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="db-size">8.5MB</div>
                <div class="stat-label">ë°ì´í„°ë² ì´ìŠ¤ í¬ê¸°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="connection-count">3</div>
                <div class="stat-label">í™œì„± ì—°ê²° ìˆ˜</div>
            </div>
        </div>

        <div class="tables-section">
            <div class="section-header">
                <h2 class="section-title">ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸”</h2>
                <button class="btn btn-analyze" onclick="refreshTableStats()">ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <div class="table-grid" id="tables-grid">
                <!-- í…Œì´ë¸” ì¹´ë“œë“¤ì´ ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
            </div>
        </div>

        <div class="query-section">
            <div class="section-header">
                <h2 class="section-title">ğŸ’» SQL ì¿¼ë¦¬ ì‹¤í–‰</h2>
                <div>
                    <button class="btn btn-view" onclick="loadSampleQuery('users')">ì‚¬ìš©ì ì¡°íšŒ</button>
                    <button class="btn btn-view" onclick="loadSampleQuery('servers')">ì„œë²„ ì¡°íšŒ</button>
                    <button class="btn btn-view" onclick="loadSampleQuery('domains')">ë„ë©”ì¸ ì¡°íšŒ</button>
                </div>
            </div>
            <textarea id="query-input" class="query-input" placeholder="SELECT * FROM users LIMIT 10;"></textarea>
            <div class="query-controls">
                <div>
                    <span style="color: #666; font-size: 14px;">âš ï¸ ì£¼ì˜: ë°ì´í„° ë³€ê²½ ì¿¼ë¦¬ëŠ” ì‹ ì¤‘íˆ ì‹¤í–‰í•˜ì„¸ìš”</span>
                </div>
                <button class="btn-execute" onclick="executeQuery()">ì¿¼ë¦¬ ì‹¤í–‰</button>
            </div>
            <div class="query-results" id="query-results" style="display: none;">
                <!-- ì¿¼ë¦¬ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
        </div>

        <div class="backup-section">
            <div class="section-header">
                <h2 class="section-title">ğŸ’¾ ë°±ì—… ê´€ë¦¬</h2>
            </div>
            <div class="backup-controls">
                <button class="btn btn-backup" onclick="createBackup()">ì „ì²´ ë°±ì—… ìƒì„±</button>
                <button class="btn btn-view" onclick="loadBackupList()">ë°±ì—… ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <div class="backup-list" id="backup-list">
                <div class="backup-item">
                    <span>ë°±ì—… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            loadTableStats();
            loadBackupList();
        });

        function loadTableStats() {
            fetch('/api/database/tables')
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        displayTables(data.tables);
                        updateStats(data.stats);
                    }
                });
        }

        function displayTables(tables) {
            const container = document.getElementById('tables-grid');
            container.innerHTML = tables.map(table => `
                <div class="table-card">
                    <div class="table-card-header">
                        <span class="table-name">${table.table_name}</span>
                        <span class="record-count">${table.row_count} í–‰</span>
                    </div>
                    <div class="table-info">
                        <div class="table-info-item">
                            <span>í¬ê¸°:</span>
                            <span>${table.size}</span>
                        </div>
                        <div class="table-info-item">
                            <span>ì»¬ëŸ¼ ìˆ˜:</span>
                            <span>${table.column_count}</span>
                        </div>
                        <div class="table-info-item">
                            <span>ë§ˆì§€ë§‰ ìˆ˜ì •:</span>
                            <span>${table.last_modified || 'ì•Œ ìˆ˜ ì—†ìŒ'}</span>
                        </div>
                    </div>
                    <div class="table-actions">
                        <button class="btn btn-view" onclick="viewTableData('${table.table_name}')">ë°ì´í„° ë³´ê¸°</button>
                        <button class="btn btn-analyze" onclick="analyzeTable('${table.table_name}')">êµ¬ì¡° ë¶„ì„</button>
                    </div>
                </div>
            `).join('');
        }

        function updateStats(stats) {
            document.getElementById('total-tables').textContent = stats.total_tables;
            document.getElementById('total-records').textContent = stats.total_records;
            document.getElementById('db-size').textContent = stats.db_size;
            document.getElementById('connection-count').textContent = stats.connection_count;
        }

        function viewTableData(tableName) {
            const query = `SELECT * FROM ${tableName} LIMIT 20;`;
            document.getElementById('query-input').value = query;
            executeQuery();
        }

        function analyzeTable(tableName) {
            const query = `
                SELECT
                    column_name,
                    data_type,
                    is_nullable,
                    column_default
                FROM information_schema.columns
                WHERE table_name = '${tableName}'
                ORDER BY ordinal_position;
            `;
            document.getElementById('query-input').value = query;
            executeQuery();
        }

        function loadSampleQuery(type) {
            const queries = {
                users: "SELECT id, phone, role, name, is_active FROM users ORDER BY id;",
                servers: "SELECT server_id, name, port, current_status, is_enabled FROM server_configs ORDER BY name;",
                domains: "SELECT hostname, target_host, target_port, is_active FROM domains ORDER BY hostname;"
            };
            document.getElementById('query-input').value = queries[type] || '';
        }

        function executeQuery() {
            const query = document.getElementById('query-input').value.trim();
            if (!query) {
                alert('ì¿¼ë¦¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ìœ„í—˜í•œ ì¿¼ë¦¬ í™•ì¸
            const dangerousKeywords = ['DROP', 'DELETE', 'TRUNCATE', 'UPDATE'];
            const isUnsafe = dangerousKeywords.some(keyword =>
                query.toUpperCase().includes(keyword)
            );

            if (isUnsafe && !confirm('ë°ì´í„°ë¥¼ ë³€ê²½í•˜ëŠ” ì¿¼ë¦¬ì…ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            fetch('/api/database/query', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query })
            })
            .then(res => res.json())
            .then(data => {
                const resultsContainer = document.getElementById('query-results');
                resultsContainer.style.display = 'block';

                if (data.success) {
                    if (data.results && data.results.length > 0) {
                        displayQueryResults(data.results);
                    } else {
                        resultsContainer.innerHTML = '<p style="padding: 20px; color: #666;">ì¿¼ë¦¬ê°€ ì„±ê³µí–ˆì§€ë§Œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    }
                } else {
                    resultsContainer.innerHTML = `<p style="padding: 20px; color: #f56565;">ì˜¤ë¥˜: ${data.error}</p>`;
                }
            });
        }

        function displayQueryResults(results) {
            if (!results || results.length === 0) return;

            const columns = Object.keys(results[0]);
            const table = `
                <table class="results-table">
                    <thead>
                        <tr>${columns.map(col => `<th>${col}</th>`).join('')}</tr>
                    </thead>
                    <tbody>
                        ${results.map(row => `
                            <tr>${columns.map(col => `<td>${row[col] || ''}</td>`).join('')}</tr>
                        `).join('')}
                    </tbody>
                </table>
                <p style="margin-top: 10px; color: #666; font-size: 14px;">
                    ì´ ${results.length}ê°œ ê²°ê³¼ í‘œì‹œ
                </p>
            `;
            document.getElementById('query-results').innerHTML = table;
        }

        function refreshTableStats() {
            loadTableStats();
        }

        function createBackup() {
            if (confirm('ì „ì²´ ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—…ì„ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                fetch('/api/database/backup', { method: 'POST' })
                    .then(res => res.json())
                    .then(data => {
                        alert(data.message || data.error);
                        if (data.success) loadBackupList();
                    });
            }
        }

        function loadBackupList() {
            fetch('/api/database/backups')
                .then(res => res.json())
                .then(data => {
                    const container = document.getElementById('backup-list');
                    if (data.success && data.backups.length > 0) {
                        container.innerHTML = data.backups.map(backup => `
                            <div class="backup-item">
                                <div>
                                    <strong>${backup.filename}</strong><br>
                                    <small style="color: #666;">${backup.created_at} | ${backup.size}</small>
                                </div>
                                <button class="btn btn-view" onclick="restoreBackup('${backup.filename}')">ë³µì›</button>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<div class="backup-item"><span>ë°±ì—… íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</span></div>';
                    }
                });
        }

        function restoreBackup(filename) {
            if (confirm(`ë°±ì—… íŒŒì¼ "${filename}"ìœ¼ë¡œ ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ? í˜„ì¬ ë°ì´í„°ê°€ ì†ì‹¤ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`)) {
                fetch('/api/database/restore', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename })
                })
                .then(res => res.json())
                .then(data => alert(data.message || data.error));
            }
        }
    </script>
</body>
</html>